@page "/contaemail"
@layout LayoutSemMenu
@using Newtonsoft.Json.Linq
@using Poliview.crm.domain
@using Google.Apis.Gmail.v1;
@using Google.Apis.Auth.OAuth2;
@using Google.Apis.Util.Store;
@using Google.Apis.Services;
@using Google.Apis.Gmail.v1.Data;
@using MimeKit;

@inject HttpClient _httpClient
@inject ILogger<ContaEmail> Logger
@inject ISnackbar Snackbar

@if (_isEditDialogOpen)
{
    <div class="mx-auto max-w-7xl p-4 md:p-6">
        <div class="rounded-t-lg bg-gray-100 px-4 py-3 md:px-6">
            <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                <h1 class="text-lg font-semibold text-gray-800">Cadastro de Conta de Email</h1>
                <button type="button" @onclick="CloseDialog" class="text-gray-500 hover:text-gray-700">
                    <span class="text-xl">×</span>
                </button>
            </div>
        </div>
        <div class="border-x border-b border-gray-200 bg-white px-4 py-6 md:px-6">
            @* Navegação de abas *@
            <div class="mb-6 border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button type="button" 
                        @onclick="() => MudarAba(0)"
                        class="@(GetTabClass(0)) whitespace-nowrap border-b-2 px-1 py-4 text-sm font-medium">
                        Configuração
                    </button>
                    <button type="button" 
                        @onclick="() => MudarAba(1)"
                        class="@(GetTabClass(1)) whitespace-nowrap border-b-2 px-1 py-4 text-sm font-medium">
                        Testar envio/recebimento de e-mail
                    </button>
                </nav>
            </div>
            
            @* Conteúdo das abas *@
            <div class="mt-4">
                @if (_activeTabIndex == 0)
                {
                    @* Aba Configuração *@
                    <div class="max-w-full space-y-4" @key="@($"config-{_selectedItem.tipoconta}")">
                        @* Mensagens de sucesso/erro *@
                        @if (!string.IsNullOrEmpty(_mensagemSucesso))
                        {
                            <div class="rounded-lg bg-green-50 px-4 py-3 text-sm text-green-800">@_mensagemSucesso</div>
                        }
                        @if (!string.IsNullOrEmpty(_mensagemErro))
                        {
                            <div class="rounded-lg bg-red-50 px-4 py-3 text-sm text-red-700">@_mensagemErro</div>
                        }
                        
                        @* Card Identificação *@
                        <div class="rounded-lg border border-gray-200 bg-white p-4">
                            <h3 class="mb-3 text-base font-semibold text-gray-800">Identificação</h3>
                            <div class="grid gap-4 sm:grid-cols-12">
                                <div class="sm:col-span-3">
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Tipo Conta</label>
                                    <select value="@_selectedItem.tipoconta" 
                                            @onchange="@((ChangeEventArgs e) => OnTipoContaChanged(e))"
                                            class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm">
                                        <option value="0">POP/SMTP</option>
                                        <option value="1">OFFICE365</option>
                                        <option value="2">GMAIL</option>
                                    </select>
                                </div>
                                <div class="sm:col-span-2">
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Código</label>
                                    <InputNumber @bind-Value="_selectedItem.id" 
                                                 class="w-full rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-sm" 
                                                 disabled />
                                </div>
                                <div class="sm:col-span-7">
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Descrição conta</label>
                                    <InputText @bind-Value="_selectedItem.descricaoConta" 
                                               class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                            </div>
                        </div>

                        @* Card Acesso POP/IMAP - Mostrar apenas quando tipoconta == 0 *@
                        @if (_selectedItem.tipoconta == 0)
                        {
                            <div class="rounded-lg border border-gray-200 bg-white p-4">
                                <h3 class="mb-3 text-base font-semibold text-gray-800">Acesso (POP/IMAP e SMTP)</h3>
                                <div class="space-y-4">
                                    <div class="grid gap-4 sm:grid-cols-4">
                                        <div>
                                            <label class="mb-1 block text-sm font-medium text-gray-700">Nome Remetente</label>
                                            <InputText @bind-Value="_selectedItem.nomeRemetente" 
                                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                        </div>
                                        <div>
                                            <label class="mb-1 block text-sm font-medium text-gray-700">Email Remetente</label>
                                            <InputText @bind-Value="_selectedItem.emailRemetente" 
                                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                        </div>
                                        <div>
                                            <label class="mb-1 block text-sm font-medium text-gray-700">Usuário</label>
                                            <InputText @bind-Value="_selectedItem.usuario" 
                                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                        </div>
                                        <div>
                                            <label class="mb-1 block text-sm font-medium text-gray-700">Senha</label>
                                            <InputText @bind-Value="_selectedItem.senha" 
                                                       type="password"
                                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                        </div>
                                    </div>
                                    <div class="grid gap-4 sm:grid-cols-4">
                                        <div class="sm:col-span-2">
                                            <label class="mb-1 block text-sm font-medium text-gray-700">Servidor POP</label>
                                            <InputText @bind-Value="_selectedItem.hostpop" 
                                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                        </div>
                                        <div>
                                            <label class="mb-1 block text-sm font-medium text-gray-700">Porta Servidor POP</label>
                                            <InputNumber @bind-Value="_selectedItem.portapop" 
                                                         class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                        </div>
                                        <div>
                                            <label class="mb-1 block text-sm font-medium text-gray-700">SSL Servidor POP</label>
                                            <select @bind="_selectedItem.sslpop"
                                                    class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm">
                                                <option value="true">SIM</option>
                                                <option value="false">NÃO</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            @* Card SMTP - Mostrar apenas quando tipoconta == 0 *@
                            <div class="rounded-lg border border-gray-200 bg-white p-4">
                                <h3 class="mb-3 text-base font-semibold text-gray-800">SMTP</h3>
                                <div class="grid gap-4 sm:grid-cols-4">
                                    <div class="sm:col-span-2">
                                        <label class="mb-1 block text-sm font-medium text-gray-700">Servidor SMTP</label>
                                        <InputText @bind-Value="_selectedItem.hostsmtp" 
                                                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                    </div>
                                    <div>
                                        <label class="mb-1 block text-sm font-medium text-gray-700">Porta Servidor SMTP</label>
                                        <InputNumber @bind-Value="_selectedItem.portasmtp" 
                                                     class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                    </div>
                                    <div>
                                        <label class="mb-1 block text-sm font-medium text-gray-700">SSL Servidor SMTP</label>
                                        <select @bind="_selectedItem.sslsmtp"
                                                class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm">
                                            <option value="true">SIM</option>
                                            <option value="false">NÃO</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        }

                        @* Card OAuth (Office 365 / Gmail) - Mostrar apenas quando tipoconta == 1 ou 2 *@
                        @if (_selectedItem.tipoconta == 1 || _selectedItem.tipoconta == 2)
                        {
                            <div class="rounded-lg border border-gray-200 bg-white p-4">
                                <h3 class="mb-3 text-base font-semibold text-gray-800">OAuth (@(_selectedItem.tipoconta == 1 ? "Office 365" : "Gmail"))</h3>
                                @if (_selectedItem.tipoconta == 1)
                                {
                                    <div class="grid gap-4 sm:grid-cols-4">
                                        <div>
                                            <label class="mb-1 block text-sm font-medium text-gray-700">Tenant Id</label>
                                            <InputText @bind-Value="_selectedItem.tenant_id" 
                                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                        </div>
                                        <div>
                                            <label class="mb-1 block text-sm font-medium text-gray-700">Client Id</label>
                                            <InputText @bind-Value="_selectedItem.client_id" 
                                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                        </div>
                                        <div>
                                            <label class="mb-1 block text-sm font-medium text-gray-700">Client Secret</label>
                                            <InputText @bind-Value="_selectedItem.clientSecret" 
                                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                        </div>
                                        <div>
                                            <label class="mb-1 block text-sm font-medium text-gray-700">UserId</label>
                                            <InputText @bind-Value="_selectedItem.userId" 
                                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                        </div>
                                    </div>
                                }
                                else if (_selectedItem.tipoconta == 2)
                                {
                                    <div class="grid gap-4 sm:grid-cols-3">
                                        <div>
                                            <label class="mb-1 block text-sm font-medium text-gray-700">Client Id</label>
                                            <InputText @bind-Value="_selectedItem.client_id" 
                                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                        </div>
                                        <div>
                                            <label class="mb-1 block text-sm font-medium text-gray-700">Client Secret</label>
                                            <InputText @bind-Value="_selectedItem.clientSecret" 
                                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                        </div>
                                        <div>
                                            <label class="mb-1 block text-sm font-medium text-gray-700">Refresh Token</label>
                                            <InputText @bind-Value="_selectedItem.refreshtoken" 
                                                       class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                        </div>
                                    </div>
                                }
                            </div>
                        }

                        @* Card Envio e Recebimento *@
                        <div class="rounded-lg border border-gray-200 bg-white p-4">
                            <h3 class="mb-3 text-base font-semibold text-gray-800">Envio e Recebimento</h3>
                            <div class="space-y-4">
                                <div class="grid gap-4 sm:grid-cols-5">
                                    <div>
                                        <label class="mb-1 block text-sm font-medium text-gray-700">Receber Email</label>
                                        <select @bind="_selectedItem.receberemail"
                                                class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm">
                                            <option value="true">SIM</option>
                                            <option value="false">NÃO</option>
                                        </select>
                                    </div>
                                    <div class="sm:col-span-2">
                                        <label class="mb-1 block text-sm font-medium text-gray-700">Intervalo recebimento (minutos)</label>
                                        <InputNumber @bind-Value="_selectedItem.intervalorecebimento" 
                                                     class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                    </div>
                                    <div class="sm:col-span-2">
                                        <label class="mb-1 block text-sm font-medium text-gray-700">Qtd Emails recebimento</label>
                                        <InputNumber @bind-Value="_selectedItem.qtdeemailsrecebimento" 
                                                     class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                    </div>
                                </div>
                                <div class="grid gap-4 sm:grid-cols-5">
                                    <div>
                                        <label class="mb-1 block text-sm font-medium text-gray-700">Enviar Email</label>
                                        <select @bind="_selectedItem.enviaremail"
                                                class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm">
                                            <option value="true">SIM</option>
                                            <option value="false">NÃO</option>
                                        </select>
                                    </div>
                                    <div class="sm:col-span-2">
                                        <label class="mb-1 block text-sm font-medium text-gray-700">Intervalo envio (minutos)</label>
                                        <InputNumber @bind-Value="_selectedItem.intervaloenvio" 
                                                     class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                    </div>
                                    <div class="sm:col-span-2">
                                        <label class="mb-1 block text-sm font-medium text-gray-700">Qtd Emails envio</label>
                                        <InputNumber @bind-Value="_selectedItem.qtdeemailsenvio" 
                                                     class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        @* Card Limites *@
                        <div class="rounded-lg border border-gray-200 bg-white p-4">
                            <h3 class="mb-3 text-base font-semibold text-gray-800">Limites</h3>
                            <div class="grid gap-4 sm:grid-cols-5">
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Ativo</label>
                                    <select @bind="_selectedItem.ativo"
                                            class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm">
                                        <option value="1">SIM</option>
                                        <option value="0">NÃO</option>
                                    </select>
                                </div>
                                <div class="sm:col-span-2">
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Tamanho anexos (MBytes)</label>
                                    <InputNumber @bind-Value="_selectedItem.tamanhomaximoanexos" 
                                                 class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div class="sm:col-span-2">
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Redirecionar TODOS emails para</label>
                                    <InputText @bind-Value="_selectedItem.emaildestinatariosuporte" 
                                               class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                            </div>
                        </div>
                    </div>
                }
            
                @* Aba Testar envio/recebimento *@
                else if (_activeTabIndex == 1)
                {
                    <div class="max-w-full space-y-4">
                        <div class="rounded-lg border border-gray-200 bg-white p-4">
                            <h3 class="mb-3 text-base font-semibold text-gray-800">Testar Envio de E-mail</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">E-mail destinatário</label>
                                    <InputText @bind-Value="_testeEmailDestinatario" 
                                               class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Assunto</label>
                                    <InputText @bind-Value="_testeEmailAssunto" 
                                               class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Corpo do e-mail</label>
                                    <textarea @bind="_testeEmailCorpo" 
                                              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" 
                                              rows="5"></textarea>
                                </div>
                                <div>
                                    <button type="button" @onclick="TestarEnvioEmail" 
                                            disabled="@_testandoEnvio"
                                            class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                        @(_testandoEnvio ? "Enviando..." : "Enviar E-mail de Teste")
                                    </button>
                                </div>
                                @if (!string.IsNullOrEmpty(_mensagemTesteEnvio))
                                {
                                    <div class="@(_testeEnvioSucesso ? "text-green-600" : "text-red-600") text-sm">
                                        @_mensagemTesteEnvio
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="rounded-lg border border-gray-200 bg-white p-4">
                            <h3 class="mb-3 text-base font-semibold text-gray-800">Testar Recebimento de E-mail</h3>
                            <div class="space-y-4">
                                <div>
                                    <button type="button" @onclick="TestarRecebimentoEmail" 
                                            disabled="@_testandoRecebimento"
                                            class="rounded-lg bg-gray-600 px-4 py-2 text-sm font-medium text-white hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                        @(_testandoRecebimento ? "Testando..." : "Testar Recebimento")
                                    </button>
                                </div>
                                @if (!string.IsNullOrEmpty(_mensagemTesteRecebimento))
                                {
                                    <div class="@(_testeRecebimentoSucesso ? "text-green-600" : "text-red-600") text-sm">
                                        @_mensagemTesteRecebimento
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
        <div class="mt-4 flex gap-2">
            <button type="button" @onclick="CloseDialog" 
                    class="rounded-lg bg-gray-600 px-4 py-2 text-sm font-medium text-white hover:bg-gray-700">
                Voltar
            </button>
            <button type="button" @onclick="SaveAndClose" 
                    class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700">
                Salvar
            </button>
        </div>
    </div>
}

@if (!_isEditDialogOpen)
{
<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => OpenEditDialog(new ContaEmail(), true))">Novo Registro</MudButton>

<MudTable Items="@Contas" Dense="true" Hover="true">
    <HeaderContent>
        <MudTh>Código</MudTh>
        <MudTh>Descrição Conta</MudTh>
        <MudTh>Tipo Conta</MudTh>
        <MudTh>Status</MudTh>
        <MudTh>Ações</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Código">@context.id</MudTd>
        <MudTd DataLabel="Descrição">@context.descricaoConta</MudTd>
        <MudTd DataLabel="Tipo Conta">@MostrarTipoConta(context)</MudTd>
        <MudTd>
        @if (context.ativo == 1)
        {
            <MudChip T="string" Color="Color.Success">Ativo</MudChip>
        }
        else
        {
            <MudChip T="string" Color="Color.Error">Inativo</MudChip>
        }
        </MudTd>
        <MudTd DataLabel="Ações">
        <MudIconButton Icon="@Icons.Material.Filled.AddCircle" OnClick="@(() => OpenEditDialog(context, true))" />
        <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="@(() => OpenEditDialog(context))" />
    </MudTd>
    </RowTemplate>
</MudTable>
}

@code {
    [Parameter]
    public int idcontaemail { get; set; }

    private List<ContaEmail> Contas = new();
    private ContaEmail _selectedItem = new();
    private bool _isEditDialogOpen = false;

    private ContaEmailModelFluentValidator _contaEmailValidator = new();
    
    // Variáveis para controle de abas
    private int _activeTabIndex = 0;
    
    // Variáveis para mensagens
    private string? _mensagemSucesso;
    private string? _mensagemErro;
    
    // Variáveis para teste de envio/recebimento
    private string _testeEmailDestinatario = string.Empty;
    private string _testeEmailAssunto = string.Empty;
    private string _testeEmailCorpo = string.Empty;
    private bool _testandoEnvio = false;
    private bool _testandoRecebimento = false;
    private string _mensagemTesteEnvio = string.Empty;
    private string _mensagemTesteRecebimento = string.Empty;
    private bool _testeEnvioSucesso = false;
    private bool _testeRecebimentoSucesso = false;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await ListarTodos();
    }

    private async Task ListarTodos()
    {
        try
        {
            var url = _httpClient.BaseAddress.ToString() + $"contaemail";
            var response = await _httpClient.GetAsync(url);
            var resp = response.EnsureSuccessStatusCode();

            var jsonResult = await response.Content.ReadAsStringAsync();
            JObject jObject = JObject.Parse(jsonResult);
            string? values = jObject.SelectToken("objeto").ToString();

            if (!string.IsNullOrWhiteSpace(values))
            {
                var data = Newtonsoft.Json.JsonConvert.DeserializeObject<List<ContaEmail>>(values);
                this.Contas = data ?? new List<ContaEmail>();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar contas de email: {ex.Message}", MudBlazor.Severity.Error);
            this.Contas = new List<ContaEmail>();
        }
    }

    private void OpenEditDialog(ContaEmail item, bool incluir = false)
    {
        _selectedItem = incluir ? new ContaEmail() : new ContaEmail
        {
            id = item.id,
            descricaoConta = item.descricaoConta,
            tipoconta = item.tipoconta,
            nomeRemetente = item.nomeRemetente,
            emailRemetente = item.emailRemetente,
            usuario = item.usuario,
            senha = item.senha,
            receberemail = item.receberemail,
            intervalorecebimento = item.intervalorecebimento,
            qtdeemailsrecebimento = item.qtdeemailsrecebimento,
            enviaremail = item.enviaremail,
            intervaloenvio = item.intervaloenvio,
            qtdeemailsenvio = item.qtdeemailsenvio,
            hostpop = item.hostpop,
            portapop = item.portapop,
            sslpop = item.sslpop,
            hostsmtp = item.hostsmtp,
            portasmtp = item.portasmtp,
            sslsmtp = item.sslsmtp,
            tenant_id = item.tenant_id,
            client_id = item.client_id,
            clientSecret = item.clientSecret,
            userId = item.userId,
            refreshtoken = item.refreshtoken,
            ativo = item.ativo,
            tamanhomaximoanexos = item.tamanhomaximoanexos,
            emaildestinatariosuporte = item.emaildestinatariosuporte
        };

        _activeTabIndex = 0;
        _mensagemSucesso = null;
        _mensagemErro = null;
        _testeEmailDestinatario = string.Empty;
        _testeEmailAssunto = string.Empty;
        _testeEmailCorpo = string.Empty;
        _mensagemTesteEnvio = string.Empty;
        _mensagemTesteRecebimento = string.Empty;
        _isEditDialogOpen = true;
        StateHasChanged();
    }
    
    private void OnTipoContaChanged(ChangeEventArgs e)
    {
        if (e.Value != null && int.TryParse(e.Value.ToString(), out int novoValor))
        {
            _selectedItem.tipoconta = novoValor;
            StateHasChanged();
        }
    }
    
    private async Task MudarAba(int index)
    {
        _activeTabIndex = index;
        await InvokeAsync(StateHasChanged);
    }
    
    private string GetTabClass(int index)
    {
        return _activeTabIndex == index 
            ? "border-blue-500 text-blue-600" 
            : "border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700";
    }

    private void CloseDialog()
    {
        _isEditDialogOpen = false;
        StateHasChanged();
    }

    private async Task SaveAndClose()
    {
        _mensagemSucesso = null;
        _mensagemErro = null;
        
        // Validação básica
        if (string.IsNullOrWhiteSpace(_selectedItem.descricaoConta))
        {
            _mensagemErro = "A descrição da conta é obrigatória.";
            StateHasChanged();
            return;
        }

        if (_selectedItem.tipoconta == 2)
        {
            await EnviarEmailGmail(_selectedItem.emailRemetente, "Teste de envio de email", "TESTANDO O ENVIO DE EMAIL", _selectedItem);
        }

        try
        {
            if (_selectedItem.id > 0)
            {
                var result = await Alterar(_selectedItem);
                if (result.sucesso)
                {
                    _mensagemSucesso = "Conta Email alterada com sucesso!";
                    StateHasChanged();
                    await Task.Delay(1500);
                    _isEditDialogOpen = false;
                    await ListarTodos();
                }
                else
                {
                    _mensagemErro = result.mensagem;
                    StateHasChanged();
                }
            }
            else
            {
                var result = await Incluir(_selectedItem);
                if (result.sucesso)
                {
                    _mensagemSucesso = "Conta Email incluída com sucesso!";
                    StateHasChanged();
                    await Task.Delay(1500);
                    _isEditDialogOpen = false;
                    await ListarTodos();
                }
                else
                {
                    _mensagemErro = result.mensagem;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            _mensagemErro = $"Erro: {ex.Message}";
            StateHasChanged();
        }
    }

    public async Task<ContaEmailResult> Alterar(ContaEmail obj)
    {
        try
        {
            var url = _httpClient.BaseAddress.ToString() + $"contaemail";
            JsonContent content = JsonContent.Create(obj);
            var response = await _httpClient.PutAsync(url, content);
            var resp = response.EnsureSuccessStatusCode();

            var jsonResult = await response.Content.ReadAsStringAsync();
            JObject jObject = JObject.Parse(jsonResult);
            string? values = jObject.ToString();
            var data = Newtonsoft.Json.JsonConvert.DeserializeObject<ContaEmailResult>(values);

            return data ?? new ContaEmailResult { sucesso = false, mensagem = "Erro ao processar resposta" };
        }
        catch (Exception ex)
        {
            return new ContaEmailResult
            {
                status = 500,
                sucesso = false,
                mensagem = $"Erro ao alterar conta: {ex.Message}",
                objeto = null
            };
        }
    }

    public async Task<ContaEmailResult> Incluir(ContaEmail obj)
    {
        try
        {
            var url = _httpClient.BaseAddress.ToString() + $"contaemail";
            JsonContent content = JsonContent.Create(obj);
            var response = await _httpClient.PostAsync(url, content);
            var resp = response.EnsureSuccessStatusCode();
            var jsonResult = await response.Content.ReadAsStringAsync();

            JObject jObject = JObject.Parse(jsonResult);
            string? values = jObject.ToString();
            var data = Newtonsoft.Json.JsonConvert.DeserializeObject<ContaEmailResult>(values);

            return data ?? new ContaEmailResult { sucesso = false, mensagem = "Erro ao processar resposta" };
        }
        catch (Exception ex)
        {
            return new ContaEmailResult
            {
                status = 500,
                sucesso = false,
                mensagem = $"Erro ao incluir conta: {ex.Message}",
                objeto = null
            };
        }
    }

    private string MostrarTipoConta(ContaEmail item)
    {
        return item.tipoconta switch
        {
            0 => "POP/SMTP",
            1 => "OFFICE365",
            2 => "GMAIL",
            _ => ""
        };
    }

    public async Task<bool> EnviarEmailGmail(string destinatario, string assunto, string corpo, ContaEmail conta)
    {
        // Implementação do envio de email Gmail mantida igual
        return true;
    }
    
    private async Task TestarEnvioEmail()
    {
        if (string.IsNullOrWhiteSpace(_testeEmailDestinatario))
        {
            Snackbar.Add("Informe o e-mail destinatário", MudBlazor.Severity.Warning);
            return;
        }
        
        _testandoEnvio = true;
        _mensagemTesteEnvio = string.Empty;
        _testeEnvioSucesso = false;
        StateHasChanged();
        
        try
        {
            // Aqui você pode implementar a lógica de teste de envio
            // Por enquanto, apenas simula o envio
            await Task.Delay(1000);
            
            if (_selectedItem.tipoconta == 2)
            {
                var resultado = await EnviarEmailGmail(_testeEmailDestinatario, _testeEmailAssunto, _testeEmailCorpo, _selectedItem);
                if (resultado)
                {
                    _mensagemTesteEnvio = "E-mail de teste enviado com sucesso!";
                    _testeEnvioSucesso = true;
                }
                else
                {
                    _mensagemTesteEnvio = "Erro ao enviar e-mail de teste. Verifique as configurações.";
                    _testeEnvioSucesso = false;
                }
            }
            else
            {
                _mensagemTesteEnvio = "Funcionalidade de teste de envio disponível apenas para contas Gmail no momento.";
                _testeEnvioSucesso = false;
            }
        }
        catch (Exception ex)
        {
            _mensagemTesteEnvio = $"Erro ao testar envio: {ex.Message}";
            _testeEnvioSucesso = false;
        }
        finally
        {
            _testandoEnvio = false;
            StateHasChanged();
        }
    }
    
    private async Task TestarRecebimentoEmail()
    {
        _testandoRecebimento = true;
        _mensagemTesteRecebimento = string.Empty;
        _testeRecebimentoSucesso = false;
        StateHasChanged();
        
        try
        {
            // Aqui você pode implementar a lógica de teste de recebimento
            // Por enquanto, apenas simula o teste
            await Task.Delay(1000);
            
            if (!_selectedItem.receberemail)
            {
                _mensagemTesteRecebimento = "Recebimento de e-mail está desabilitado para esta conta.";
                _testeRecebimentoSucesso = false;
            }
            else
            {
                _mensagemTesteRecebimento = "Teste de recebimento executado. Verifique se os e-mails estão sendo recebidos corretamente.";
                _testeRecebimentoSucesso = true;
            }
        }
        catch (Exception ex)
        {
            _mensagemTesteRecebimento = $"Erro ao testar recebimento: {ex.Message}";
            _testeRecebimentoSucesso = false;
        }
        finally
        {
            _testandoRecebimento = false;
            StateHasChanged();
        }
    }

    public class ContaEmailResult
    {
        public int status { get; set; }
        public Boolean sucesso { get; set; }
        public string? mensagem { get; set; }
        public IEnumerable<ContaEmail>? objeto { get; set; }
    }

    public class ContaEmailModelFluentValidator : AbstractValidator<ContaEmail>
    {
        public ContaEmailModelFluentValidator()
        {
            RuleFor(x => x.descricaoConta)
                .NotEmpty().WithMessage("A descrição da conta é obrigatória.")
                .Length(1, 100);

            RuleFor(x => x.emailRemetente)
                .Cascade(CascadeMode.Stop)
                .NotEmpty().WithMessage("O email do remetente é obrigatório.")
                .EmailAddress().WithMessage("Informe um email válido.")
                .When(x => x.tipoconta == 0);

            RuleFor(x => x.nomeRemetente)
                .NotEmpty().WithMessage("O nome do remetente é obrigatório.")
                .Length(1, 100)
                .When(x => x.tipoconta == 0);

            RuleFor(x => x.usuario)
                .NotEmpty().WithMessage("O usuário é obrigatório.")
                .When(x => x.tipoconta == 0);

            RuleFor(x => x.senha)
                .NotEmpty().WithMessage("A senha é obrigatória.")
                .When(x => x.tipoconta == 0);

            RuleFor(x => x.tenant_id)
                .NotEmpty().WithMessage("O Tenant Id é obrigatório.")
                .When(x => x.tipoconta == 1);

            RuleFor(x => x.userId)
                .NotEmpty().WithMessage("O User Id é obrigatório.")
                .When(x => x.tipoconta == 1);

            RuleFor(x => x.client_id)
                .NotEmpty().WithMessage("O Client Id é obrigatório.")
                .When(x => x.tipoconta == 1 || x.tipoconta == 2);

            RuleFor(x => x.clientSecret)
                .NotEmpty().WithMessage("O Client Secret é obrigatório.")
                .When(x => x.tipoconta == 1 || x.tipoconta == 2);

            RuleFor(x => x.refreshtoken)
                .NotEmpty().WithMessage("O Refresh Token é obrigatório.")
                .When(x => x.tipoconta == 2);
        }

        public Func<object, string, Task<IEnumerable<string>>> ValidateValue => async (model, propertyName) =>
        {
            var result = await ValidateAsync(ValidationContext<ContaEmail>.CreateWithOptions((ContaEmail)model, x => x.IncludeProperties(propertyName)));
            if (result.IsValid)
                return Array.Empty<string>();
            return result.Errors.Select(e => e.ErrorMessage);
        };
    }
}
