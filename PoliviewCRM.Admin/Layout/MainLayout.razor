@inherits LayoutComponentBase
@implements IDisposable
@inject NavigationManager NavigationManager
@inject IAuthTokenService AuthTokenService
@inject AuthenticationStateProvider AuthStateProvider
@inject IThemeService ThemeService

<div class="flex h-screen overflow-hidden font-outfit bg-gray-50 dark:bg-gray-900">
    <aside
        class="@(SidebarOpen ? "translate-x-0 lg:w-[290px] lg:px-5" : "-translate-x-full lg:translate-x-0 lg:w-20 lg:px-2") sidebar fixed left-0 top-0 z-[9999] flex h-screen w-[290px] flex-col overflow-y-auto border-r border-gray-200 bg-white dark:border-gray-700 dark:bg-gray-800 px-5 transition-all duration-300 lg:static">
        <div class="flex items-center justify-start gap-2 border-b border-gray-100 dark:border-gray-700 pb-7 pt-8">
            <div class="@GetLogoContainerClass()">
                <img src="/images/logo.png" alt="SIECON" class="h-full w-auto object-contain" style="max-height: 40px;" />
            </div>
        </div>
        <nav class="flex flex-col overflow-y-auto py-4">
            <div class="mb-6">
                <h3 class="@GetMenuTitleClass()">Menu</h3>
                <ul class="flex flex-col gap-1">
                    @* Acesso Banco Dados *@
                    <li>
                        <NavLink href="/acesso-banco-dados"
                            class="@GetMenuItemClass()"
                            title="@GetTooltip("Acesso Banco Dados")"
                            Match="NavLinkMatch.All"
                            @onclick="() => ExpandirSidebarSeRecolhido()">
                            <Icon Name="database" Class="h-6 w-6 flex-shrink-0" />
                            <span class="@GetMenuItemTextClass()">Acesso Banco Dados</span>
                        </NavLink>
                    </li>
                    
                    @* Parâmetros *@
                    <li>
                        <div class="relative">
                            <button type="button" 
                                @onclick="() => { ExpandirSidebarSeRecolhido(); ToggleParametros(); }"
                                title="@GetTooltip("Parâmetros")"
                                class="@GetParametrosButtonClass()">
                                <Icon Name="cog6tooth" Class="h-6 w-6 flex-shrink-0" />
                                <span class="@GetMenuItemTextClass()">Parâmetros</span>
                                <Icon Name="chevron-down" Class="@GetChevronClass()" />
                            </button>
                            @if (ParametrosExpandido && SidebarOpen)
                            {
                                <ul class="mt-1 flex flex-col gap-0.5 pl-9">
                                    @foreach (var item in SubmenusParametros)
                                    {
                                        <li>
                                            <NavLink href="@($"/parametros/{item.Slug}")"
                                                class="menu-dropdown-item flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium"
                                                Match="NavLinkMatch.All"
                                                @onclick="() => ExpandirSidebarSeRecolhido()">
                                                <Icon Name="@GetIconName(item.Slug)" Class="h-5 w-5" />
                                                @item.Titulo
                                            </NavLink>
                                        </li>
                                    }
                                </ul>
                            }
                        </div>
                    </li>
                    
                    @* Sair *@
                    <li>
                        <button type="button" @onclick="Sair"
                            title="@GetTooltip("Sair")"
                            class="@GetSairButtonClass()">
                            <Icon Name="arrow-right-on-rectangle" Class="h-6 w-6 flex-shrink-0" />
                            <span class="@GetMenuItemTextClass()">Sair</span>
                        </button>
                    </li>
                </ul>
            </div>
        </nav>
    </aside>

    <div class="relative flex flex-1 flex-col overflow-x-hidden overflow-y-auto">
        <header class="sticky top-0 z-[99999] flex w-full border-b border-gray-200 bg-white dark:border-gray-700 dark:bg-gray-800">
            <div class="flex w-full grow flex-col items-center justify-between px-3 py-3 lg:flex-row lg:px-6 lg:py-4">
                <div class="flex w-full items-center justify-between gap-2 lg:justify-normal">
                    <button type="button" @onclick="ToggleSidebar"
                        class="flex h-10 w-10 items-center justify-center rounded-lg border border-gray-200 text-gray-500 hover:bg-gray-100 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 lg:h-11 lg:w-11">
                        <Icon Name="bars-3" Class="h-5 w-5" />
                    </button>
                    <div class="hidden lg:block flex-1 max-w-md">
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400">
                                <Icon Name="magnifying-glass" Class="h-5 w-5" />
                            </span>
                            <input type="text" placeholder="Pesquisar..."
                                class="h-11 w-full rounded-lg border border-gray-200 bg-transparent py-2.5 pl-12 pr-4 text-sm text-gray-800 placeholder-gray-400 focus:border-brand-300 focus:outline-none focus:ring-2 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-700 dark:text-gray-200 dark:placeholder-gray-500 dark:focus:border-primary-400" />
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button type="button" @onclick="ToggleTheme"
                            class="flex h-10 w-10 items-center justify-center rounded-lg border border-gray-200 text-gray-500 hover:bg-gray-100 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-800 lg:h-11 lg:w-11"
                            title="@(_currentTheme == "dark" ? "Alternar para tema claro" : "Alternar para tema escuro")">
                            @if (_currentTheme == "dark")
                            {
                                <Icon Name="sun" Class="h-5 w-5" />
                            }
                            else
                            {
                                <Icon Name="moon" Class="h-5 w-5" />
                            }
                        </button>
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Usuário</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 bg-gray-50 dark:bg-gray-900">
            @Body
        </main>
    </div>
</div>

@code {
    private bool SidebarOpen { get; set; } = true;
    private bool ParametrosExpandido { get; set; }
    private string _currentTheme = "light";

    @* private static readonly List<(string Titulo, string Slug)> SubmenusParametros = new()
    {
        ("Integração SIECONSP7", "integracao-sieconsp7"),
        ("Contas de Email", "contas-email"),
        ("Empresas", "empresas"),
        ("Jornada", "jornada"),
        ("SLA", "sla"),
        ("Avisos por Email", "avisos-email"),
        ("Prospect", "prospect"),
        ("Identidade Visual", "identidade-visual"),
        ("Caminhos", "caminhos"),
        ("Páginas Sistema", "paginas-sistema"),
        ("Status de Operações", "status-operacoes"),
        ("Ordem de Serviço", "ordem-servico"),
        ("Chamados", "chamados"),
        ("Rastreamento Email", "rastreamento-email"),
        ("Link Boleto", "link-boleto"),
        ("Portal Cliente", "portal-cliente"),
        ("Monitoramento de Serviços", "monitoramento-servicos"),
        ("Aviso Portal Cliente", "aviso-portal-cliente"),
        ("Política de Senhas", "politica-senhas"),
        ("Integração Mobuss", "integracao-mobuss"),
        ("Espaço Cliente", "espaco-cliente")
    }; *@

    private static readonly List<(string Titulo, string Slug)> SubmenusParametros = new()
{
("Integração SIECONSP7", "integracao-sieconsp7"),
("Contas de Email", "contas-email"),
("Empresas", "empresas"),
("Jornada", "jornada"),
("SLA", "sla"),
("Avisos por Email", "avisos-email"),
("Identidade Visual", "identidade-visual"),
("Caminhos", "caminhos"),
("Páginas Sistema", "paginas-sistema"),
("Status de Operações", "status-operacoes"),
("Ordem de Serviço", "ordem-servico"),
("Chamados", "chamados"),
("Rastreamento Email", "rastreamento-email"),
("Link Boleto", "link-boleto"),
("Portal Cliente", "portal-cliente"),
("Monitoramento de Serviços", "monitoramento-servicos"),
("Aviso Portal Cliente", "aviso-portal-cliente"),
("Política de Senhas", "politica-senhas"),
("Integração Mobuss", "integracao-mobuss"),
("Espaço Cliente", "espaco-cliente")
};


    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _currentTheme = await ThemeService.GetThemeAsync();
        ThemeService.ThemeChanged += OnThemeChanged;
        AtualizarEstadoParametros();
        NavigationManager.LocationChanged += OnLocationChanged;
    }
    
    private void OnThemeChanged(string theme)
    {
        _currentTheme = theme;
        InvokeAsync(StateHasChanged);
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        AtualizarEstadoParametros();
        InvokeAsync(StateHasChanged);
    }

    private void AtualizarEstadoParametros()
    {
        var path = new Uri(NavigationManager.Uri).AbsolutePath;
        ParametrosExpandido = path.StartsWith("/parametros", StringComparison.OrdinalIgnoreCase);
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        ThemeService.ThemeChanged -= OnThemeChanged;
    }
    
    private async Task ToggleTheme()
    {
        await ThemeService.ToggleThemeAsync();
    }

    private void ToggleSidebar()
    {
        SidebarOpen = !SidebarOpen;
        StateHasChanged();
    }

    private void ExpandirSidebarSeRecolhido()
    {
        if (!SidebarOpen)
        {
            SidebarOpen = true;
            StateHasChanged();
        }
    }

    private void ToggleParametros()
    {
        ParametrosExpandido = !ParametrosExpandido;
    }

    private async Task Sair()
    {
        await AuthTokenService.ClearAsync();
        if (AuthStateProvider is CustomAuthStateProvider provider)
            provider.NotifyAuthenticationStateChanged();
        NavigationManager.NavigateTo("/login", forceLoad: true);
    }

    private string GetMenuItemClass()
    {
        var classes = new List<string> { "menu-link", "flex", "items-center", "gap-3", "rounded-lg", "px-3", "py-2.5", "text-sm", "font-medium" };
        if (!SidebarOpen)
        {
            classes.Add("lg:justify-center");
            classes.Add("lg:px-2");
        }
        return string.Join(" ", classes);
    }

    private string GetMenuItemTextClass()
    {
        return SidebarOpen ? "" : "lg:hidden";
    }

    private string GetParametrosButtonClass()
    {
        var classes = new List<string> { "menu-link", "flex", "w-full", "items-center", "gap-3", "rounded-lg", "px-3", "py-2.5", "text-sm", "font-medium" };
        if (ParametrosExpandido)
        {
            classes.Add("menu-link");
            classes.Add("active");
        }
        if (!SidebarOpen)
        {
            classes.Add("lg:justify-center");
            classes.Add("lg:px-2");
        }
        return string.Join(" ", classes);
    }

    private string GetSairButtonClass()
    {
        var classes = new List<string> { "menu-link", "flex", "w-full", "items-center", "gap-3", "rounded-lg", "px-3", "py-2.5", "text-sm", "font-medium", "text-red-600", "hover:bg-red-50" };
        if (!SidebarOpen)
        {
            classes.Add("lg:justify-center");
            classes.Add("lg:px-2");
        }
        return string.Join(" ", classes);
    }

    private string GetLogoContainerClass()
    {
        var classes = new List<string> { "flex", "h-16", "items-center", "justify-center" };
        if (!SidebarOpen)
        {
            classes.Add("lg:hidden");
        }
        return string.Join(" ", classes);
    }

    private string GetMenuTitleClass()
    {
        var classes = new List<string> { "mb-4", "text-xs", "font-medium", "uppercase", "leading-5", "text-gray-400", "dark:text-gray-500" };
        if (!SidebarOpen)
        {
            classes.Add("lg:hidden");
        }
        return string.Join(" ", classes);
    }

    private string GetTooltip(string text)
    {
        // Retorna o texto do tooltip apenas quando o sidebar está recolhido
        return !SidebarOpen ? text : "";
    }

    private string GetChevronClass()
    {
        var classes = new List<string> { "ml-auto", "h-5", "w-5", "transition-transform" };
        if (ParametrosExpandido)
        {
            classes.Add("rotate-180");
        }
        if (!SidebarOpen)
        {
            classes.Add("lg:hidden");
        }
        return string.Join(" ", classes);
    }

    private string GetIconName(string slug)
    {
        return slug.ToLower() switch
        {
            "integracao-sieconsp7" => "arrow-path-rounded-square",
            "contas-email" => "envelope",
            "empresas" => "building-office",
            "jornada" => "clock",
            "sla" => "chart-bar",
            "avisos-email" => "megaphone",
            "identidade-visual" => "paint-brush",
            "caminhos" => "map",
            "paginas-sistema" => "document-text",
            "status-operacoes" => "arrow-path",
            "ordem-servico" => "wrench-screwdriver",
            "chamados" => "chat-bubble-left-right",
            "rastreamento-email" => "magnifying-glass",
            "link-boleto" => "banknotes",
            "portal-cliente" => "globe-alt",
            "monitoramento-servicos" => "computer-desktop",
            "aviso-portal-cliente" => "exclamation-triangle",
            "politica-senhas" => "key",
            "integracao-mobuss" => "arrow-path-rounded-square",
            "espaco-cliente" => "user-group",
            _ => "document-text"
        };
    }
}
