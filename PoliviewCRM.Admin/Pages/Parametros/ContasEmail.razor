@page "/parametros/contas-email"
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Contas de E-mail | Parâmetros | SIECON CRM</PageTitle>

<div class="mx-auto max-w-7xl p-4 md:p-6">
    <div class="rounded-t-lg bg-gray-100 px-4 py-3 md:px-6">
        <div class="flex items-center justify-between">
            <h1 class="text-lg font-semibold text-gray-800">Parâmetros do Sistema -> Contas de E-mail</h1>
            @if (_mostrarEdicao)
            {
                <button type="button" @onclick="VoltarParaGrid"
                    class="rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
                    ← Voltar
                </button>
            }
        </div>
    </div>
    <div class="border-x border-b border-gray-200 bg-white px-4 py-6 md:px-6">
        @if (!_mostrarEdicao)
        {
            <h2 class="mb-4 text-base font-semibold text-gray-800">Contas de E-mail</h2>
        }

        @if (_mostrarEdicao)
        {
            @* Tela de edição (incluir ou alterar) *@
            <div class="space-y-4">
                @if (!string.IsNullOrEmpty(_mensagemSucesso))
                {
                    <div class="rounded-lg bg-green-50 px-4 py-3 text-sm text-green-800">@_mensagemSucesso</div>
                }
                @if (!string.IsNullOrEmpty(_mensagemErro))
                {
                    <div class="rounded-lg bg-red-50 px-4 py-3 text-sm text-red-700">@_mensagemErro</div>
                }
                @if (_editando is not null)
                {
                    @* Navegação de abas *@
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button type="button" 
                                @onclick="() => MudarAba(0)"
                                class="@(GetTabClass(0)) whitespace-nowrap border-b-2 px-1 py-4 text-sm font-medium">
                                Configuração
                            </button>
                            <button type="button" 
                                @onclick="() => MudarAba(1)"
                                class="@(GetTabClass(1)) whitespace-nowrap border-b-2 px-1 py-4 text-sm font-medium">
                                Testar envio/recebimento de e-mail
                            </button>
                        </nav>
                    </div>

                    <div class="max-w-4xl space-y-6">
                        @if (_activeTabIndex == 0)
                        {
                            @* Aba Configuração *@
                            <section class="rounded-lg border border-gray-200 p-4">
                                <h3 class="mb-3 text-sm font-semibold text-gray-700">Identificação</h3>
                            <div class="grid gap-4 sm:grid-cols-2">
                                <div class="sm:col-span-2">
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Descrição da conta</label>
                                    <InputText @bind-Value="_editando.descricaoConta" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" placeholder="Ex.: Suporte" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Nome remetente</label>
                                    <InputText @bind-Value="_editando.nomeRemetente" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">E-mail remetente</label>
                                    <InputText @bind-Value="_editando.emailRemetente" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" type="email" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Tipo de conta</label>
                                    <select value="@_editando.tipoconta" 
                                            @onchange="@((ChangeEventArgs e) => OnTipoContaChanged(e))"
                                            class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm">
                                        <option value="0">Padrão (SMTP/POP)</option>
                                        <option value="1">Office 365</option>
                                        <option value="2">Gmail</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Ativo</label>
                                    <select @bind="_editando.ativo" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm">
                                        <option value="1">Sim</option>
                                        <option value="0">Não</option>
                                    </select>
                                </div>
                            </div>
                        </section>

                        @* Card Acesso POP/IMAP - Mostrar apenas quando tipoconta == 0 *@
                        @if (_editando.tipoconta == 0)
                        {
                            <section class="rounded-lg border border-gray-200 p-4">
                                <h3 class="mb-3 text-sm font-semibold text-gray-700">Acesso (POP/IMAP e SMTP)</h3>
                            <div class="grid gap-4 sm:grid-cols-2">
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Usuário</label>
                                    <InputText @bind-Value="_editando.usuario" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Senha</label>
                                    <InputText @bind-Value="_editando.senha" type="password" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Host POP</label>
                                    <InputText @bind-Value="_editando.hostpop" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Porta POP</label>
                                    <InputNumber @bind-Value="_editando.portapop" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div class="flex items-center gap-2">
                                    <InputCheckbox @bind-Value="_editando.sslpop" id="sslpop" class="h-4 w-4 rounded border-gray-300" />
                                    <label for="sslpop" class="text-sm font-medium text-gray-700">SSL POP</label>
                                </div>
                            </div>
                            </section>

                            @* Card SMTP - Mostrar apenas quando tipoconta == 0 *@
                            <section class="rounded-lg border border-gray-200 p-4">
                                <h3 class="mb-3 text-sm font-semibold text-gray-700">SMTP</h3>
                            <div class="grid gap-4 sm:grid-cols-2">
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Host SMTP</label>
                                    <InputText @bind-Value="_editando.hostsmtp" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Porta SMTP</label>
                                    <InputNumber @bind-Value="_editando.portasmtp" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div class="flex items-center gap-2">
                                    <InputCheckbox @bind-Value="_editando.sslsmtp" id="sslsmtp" class="h-4 w-4 rounded border-gray-300" />
                                    <label for="sslsmtp" class="text-sm font-medium text-gray-700">SSL SMTP</label>
                                </div>
                            </div>
                            </section>
                        }

                        @* Card OAuth - Mostrar apenas quando tipoconta == 1 ou 2 *@
                        @if (_editando.tipoconta == 1 || _editando.tipoconta == 2)
                        {
                            <section class="rounded-lg border border-gray-200 p-4">
                                <h3 class="mb-3 text-sm font-semibold text-gray-700">OAuth (@(_editando.tipoconta == 1 ? "Office 365" : "Gmail"))</h3>
                            <div class="grid gap-4 sm:grid-cols-2">
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Tenant ID</label>
                                    <InputText @bind-Value="_editando.tenant_id" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Client ID</label>
                                    <InputText @bind-Value="_editando.client_id" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Client Secret</label>
                                    <InputText @bind-Value="_editando.clientSecret" type="password" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">User ID</label>
                                    <InputText @bind-Value="_editando.userId" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div class="sm:col-span-2">
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Refresh Token</label>
                                    <InputText @bind-Value="_editando.refresh_token" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                            </div>
                            </section>
                        }

                        <section class="rounded-lg border border-gray-200 p-4">
                            <h3 class="mb-3 text-sm font-semibold text-gray-700">Envio e Recebimento</h3>
                            <div class="grid gap-4 sm:grid-cols-2">
                                <div class="flex items-center gap-2">
                                    <InputCheckbox @bind-Value="_editando.enviaremail" id="enviaremail" class="h-4 w-4 rounded border-gray-300" />
                                    <label for="enviaremail" class="text-sm font-medium text-gray-700">Enviar e-mail</label>
                                </div>
                                <div class="flex items-center gap-2">
                                    <InputCheckbox @bind-Value="_editando.receberemail" id="receberemail" class="h-4 w-4 rounded border-gray-300" />
                                    <label for="receberemail" class="text-sm font-medium text-gray-700">Receber e-mail</label>
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Intervalo recebimento (min)</label>
                                    <InputNumber @bind-Value="_editando.intervalorecebimento" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Intervalo envio (min)</label>
                                    <InputNumber @bind-Value="_editando.intervaloenvio" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Qtde e-mails recebimento</label>
                                    <InputNumber @bind-Value="_editando.qtdeemailsrecebimento" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Qtde e-mails envio</label>
                                    <InputNumber @bind-Value="_editando.qtdeemailsenvio" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Tentativas de envio</label>
                                    <InputNumber @bind-Value="_editando.qtdetentativasenvio" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                            </div>
                        </section>

                        <section class="rounded-lg border border-gray-200 p-4">
                            <h3 class="mb-3 text-sm font-semibold text-gray-700">Limites</h3>
                            <div class="grid gap-4 sm:grid-cols-2">
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">Tamanho máx. anexos (MB)</label>
                                    <InputNumber @bind-Value="_editando.tamanhomaximoanexos" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">E-mail destinatários suporte</label>
                                    <InputText @bind-Value="_editando.emaildestinatariosuporte" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">E-mails por dia</label>
                                    <InputNumber @bind-Value="_editando.EmailsPorDia" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                                <div>
                                    <label class="mb-1 block text-sm font-medium text-gray-700">E-mails mala direta por dia</label>
                                    <InputNumber @bind-Value="_editando.EmailsMalaDiretaPorDia" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
                                </div>
                            </div>
                        </section>
                        }
                        @* Fim da aba Configuração *@
                        else if (_activeTabIndex == 1)
                        {
                            @* Aba Testar envio/recebimento *@
                            <section class="rounded-lg border border-gray-200 p-4">
                                <h3 class="mb-3 text-sm font-semibold text-gray-700">Testar Envio de E-mail</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="mb-1 block text-sm font-medium text-gray-700">E-mail destinatário</label>
                                        <InputText @bind-Value="_testeEmailDestinatario" 
                                                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" 
                                                   placeholder="email@exemplo.com" />
                                    </div>
                                    <div>
                                        <label class="mb-1 block text-sm font-medium text-gray-700">Assunto</label>
                                        <InputText @bind-Value="_testeEmailAssunto" 
                                                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" 
                                                   placeholder="Teste de envio" />
                                    </div>
                                    <div>
                                        <label class="mb-1 block text-sm font-medium text-gray-700">Corpo do e-mail</label>
                                        <textarea @bind="_testeEmailCorpo" 
                                                  class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" 
                                                  rows="5"
                                                  placeholder="Digite o corpo do e-mail de teste..."></textarea>
                                    </div>
                                    <div>
                                        <button type="button" @onclick="TestarEnvioEmail" 
                                                disabled="@_testandoEnvio"
                                                class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                            @(_testandoEnvio ? "Enviando..." : "Enviar E-mail de Teste")
                                        </button>
                                    </div>
                                    @if (!string.IsNullOrEmpty(_mensagemTesteEnvio))
                                    {
                                        <div class="@(_testeEnvioSucesso ? "text-green-600" : "text-red-600") text-sm">
                                            @_mensagemTesteEnvio
                                        </div>
                                    }
                                </div>
                            </section>

                            <section class="rounded-lg border border-gray-200 p-4">
                                <h3 class="mb-3 text-sm font-semibold text-gray-700">Testar Recebimento de E-mail</h3>
                                <div class="space-y-4">
                                    <div>
                                        <button type="button" @onclick="TestarRecebimentoEmail" 
                                                disabled="@_testandoRecebimento"
                                                class="rounded-lg bg-gray-600 px-4 py-2 text-sm font-medium text-white hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                            @(_testandoRecebimento ? "Testando..." : "Testar Recebimento")
                                        </button>
                                    </div>
                                    @if (!string.IsNullOrEmpty(_mensagemTesteRecebimento))
                                    {
                                        <div class="@(_testeRecebimentoSucesso ? "text-green-600" : "text-red-600") text-sm">
                                            @_mensagemTesteRecebimento
                                        </div>
                                    }
                                </div>
                            </section>
                        }

                        <div class="mt-6 flex gap-2">
                            <button type="button" @onclick="Salvar" disabled="@_salvando"
                                class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 disabled:opacity-50">
                                @(_salvando ? "Salvando..." : "Salvar")
                            </button>
                            <button type="button" @onclick="VoltarParaGrid"
                                class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
                                Cancelar
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            @* Grid de listagem *@
            @if (!string.IsNullOrEmpty(_mensagemSucesso))
            {
                <div class="mb-4 rounded-lg bg-green-50 px-4 py-3 text-sm text-green-800">@_mensagemSucesso</div>
            }
            @if (!string.IsNullOrEmpty(_mensagemErro))
            {
                <div class="mb-4 rounded-lg bg-red-50 px-4 py-3 text-sm text-red-700">@_mensagemErro</div>
            }
            @if (_carregando)
            {
                <p class="text-sm text-gray-500">Carregando...</p>
            }
            else
            {
                <div class="mb-4 flex gap-2">
                    <button type="button" @onclick="Incluir"
                        class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700">
                        Incluir
                    </button>
                </div>
                @if (_lista is null || _lista.Count == 0)
                {
                    <p class="text-sm text-gray-500">Nenhuma conta de e-mail cadastrada.</p>
                }
                else
                {
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200 text-left text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 font-medium text-gray-700">Id</th>
                                    <th class="px-4 py-2 font-medium text-gray-700">Descrição</th>
                                    <th class="px-4 py-2 font-medium text-gray-700">Nome remetente</th>
                                    <th class="px-4 py-2 font-medium text-gray-700">E-mail remetente</th>
                                    <th class="px-4 py-2 font-medium text-gray-700">Tipo</th>
                                    <th class="px-4 py-2 font-medium text-gray-700">Ativo</th>
                                    <th class="px-4 py-2 font-medium text-gray-700">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 bg-white">
                                @foreach (var item in _lista!)
                                {
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-2 text-gray-600">@item.id</td>
                                        <td class="px-4 py-2">@item.descricaoConta</td>
                                        <td class="px-4 py-2">@item.nomeRemetente</td>
                                        <td class="px-4 py-2">@item.emailRemetente</td>
                                        <td class="px-4 py-2">@NomeTipoConta(item.tipoconta)</td>
                                        <td class="px-4 py-2">@(item.ativo == 1 ? "Sim" : "Não")</td>
                                        <td class="px-4 py-2">
                                            <button type="button" @onclick="() => Alterar(item)" class="mr-2 text-blue-600 hover:underline">Alterar</button>
                                            <button type="button" @onclick="() => Excluir(item)" class="text-red-600 hover:underline">Excluir</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            }
        }
    </div>
</div>

@code {
    private List<ContaEmail>? _lista;
    private bool _carregando;
    private bool _mostrarEdicao;
    private ContaEmail? _editando;
    private bool _salvando;
    private string? _mensagemErro;
    private string? _mensagemSucesso;
    
    // Variáveis para controle de abas
    private int _activeTabIndex = 0;
    
    // Variáveis para teste de envio/recebimento
    private string _testeEmailDestinatario = string.Empty;
    private string _testeEmailAssunto = string.Empty;
    private string _testeEmailCorpo = string.Empty;
    private bool _testandoEnvio = false;
    private bool _testandoRecebimento = false;
    private string _mensagemTesteEnvio = string.Empty;
    private string _mensagemTesteRecebimento = string.Empty;
    private bool _testeEnvioSucesso = false;
    private bool _testeRecebimentoSucesso = false;

    protected override async Task OnInitializedAsync()
    {
        await CarregarLista();
    }

    private async Task CarregarLista()
    {
        _carregando = true;
        _mensagemErro = null;
        try
        {
            var response = await Http.GetAsync("contaemail");
            if (response.IsSuccessStatusCode)
            {
                var data = await response.Content.ReadFromJsonAsync<ContaEmailResposta>();
                _lista = data?.objeto?.ToList() ?? new List<ContaEmail>();
            }
            else
            {
                var body = await response.Content.ReadAsStringAsync();
                _mensagemErro = $"Erro ao carregar: {response.StatusCode}. {body}";
                _lista = new List<ContaEmail>();
            }
        }
        catch (Exception ex)
        {
            _mensagemErro = ex.Message;
            _lista = new List<ContaEmail>();
        }
        finally
        {
            _carregando = false;
        }
    }

    private static string NomeTipoConta(int tipo)
    {
        return tipo switch { 0 => "Padrão", 1 => "Office 365", 2 => "Gmail", _ => "-" };
    }

    private void Incluir()
    {
        _editando = new ContaEmail
        {
            tipoconta = 0,
            sslpop = true,
            portapop = 995,
            sslsmtp = true,
            portasmtp = 587,
            enviaremail = true,
            receberemail = true,
            intervalorecebimento = 1,
            intervaloenvio = 1,
            qtdeemailsrecebimento = 20,
            qtdeemailsenvio = 30,
            qtdetentativasenvio = 3,
            tamanhomaximoanexos = 10,
            ativo = 1
        };
        _mostrarEdicao = true;
        _mensagemErro = null;
        _mensagemSucesso = null;
        ResetarAbas();
    }

    private void Alterar(ContaEmail item)
    {
        _editando = new ContaEmail
        {
            id = item.id,
            tipoconta = item.tipoconta,
            descricaoConta = item.descricaoConta ?? "",
            nomeRemetente = item.nomeRemetente ?? "",
            emailRemetente = item.emailRemetente ?? "",
            usuario = item.usuario ?? "",
            senha = item.senha ?? "",
            hostpop = item.hostpop ?? "",
            sslpop = item.sslpop,
            portapop = item.portapop,
            hostsmtp = item.hostsmtp ?? "",
            sslsmtp = item.sslsmtp,
            portasmtp = item.portasmtp,
            tenant_id = item.tenant_id ?? "",
            client_id = item.client_id ?? "",
            clientSecret = item.clientSecret ?? "",
            refresh_token = item.refresh_token,
            userId = item.userId ?? "",
            enviaremail = item.enviaremail,
            receberemail = item.receberemail,
            intervalorecebimento = item.intervalorecebimento,
            intervaloenvio = item.intervaloenvio,
            qtdeemailsrecebimento = item.qtdeemailsrecebimento,
            qtdeemailsenvio = item.qtdeemailsenvio,
            qtdetentativasenvio = item.qtdetentativasenvio,
            tamanhomaximoanexos = item.tamanhomaximoanexos,
            emaildestinatariosuporte = item.emaildestinatariosuporte ?? "",
            ativo = item.ativo,
            EmailsPorDia = item.EmailsPorDia,
            EmailsMalaDiretaPorDia = item.EmailsMalaDiretaPorDia,
            SocketOptions = item.SocketOptions
        };
        _mostrarEdicao = true;
        _mensagemErro = null;
        _mensagemSucesso = null;
        ResetarAbas();
    }

    private void ResetarAbas()
    {
        _activeTabIndex = 0;
        _testeEmailDestinatario = string.Empty;
        _testeEmailAssunto = "Teste de envio de e-mail";
        _testeEmailCorpo = "Este é um e-mail de teste enviado pelo sistema SIECON CRM.";
        _mensagemTesteEnvio = string.Empty;
        _mensagemTesteRecebimento = string.Empty;
        _testeEnvioSucesso = false;
        _testeRecebimentoSucesso = false;
    }

    private async Task VoltarParaGrid()
    {
        _mostrarEdicao = false;
        _editando = null;
        _mensagemErro = null;
        _mensagemSucesso = null;
        await CarregarLista();
    }

    private async Task Salvar()
    {
        if (_editando is null) return;
        _salvando = true;
        _mensagemErro = null;
        _mensagemSucesso = null;
        try
        {
            HttpResponseMessage response;
            if (_editando.id == 0)
            {
                response = await Http.PostAsJsonAsync("contaemail", _editando);
            }
            else
            {
                response = await Http.PutAsJsonAsync("contaemail", _editando);
            }
            var body = await response.Content.ReadAsStringAsync();
            if (response.IsSuccessStatusCode)
            {
                var ret = System.Text.Json.JsonSerializer.Deserialize<Retorno>(body);
                if (ret?.sucesso == true)
                {
                    await VoltarParaGrid();
                    _mensagemSucesso = "Registro salvo com sucesso.";
                }
                else
                {
                    _mensagemErro = ret?.mensagem ?? body;
                }
            }
            else
            {
                _mensagemErro = response.StatusCode == System.Net.HttpStatusCode.Unauthorized
                    ? "Não autorizado. Faça login novamente."
                    : (string.IsNullOrWhiteSpace(body) ? response.ReasonPhrase : body);
            }
        }
        catch (Exception ex)
        {
            _mensagemErro = ex.Message;
        }
        finally
        {
            _salvando = false;
            StateHasChanged();
        }
    }

    private async Task Excluir(ContaEmail item)
    {
        var confirmar = await JS.InvokeAsync<bool>("confirm", $"Excluir a conta \"{item.descricaoConta}\"?");
        if (!confirmar) return;
        _mensagemErro = null;
        _mensagemSucesso = null;
        try
        {
            var response = await Http.DeleteAsync($"contaemail/{item.id}");
            var body = await response.Content.ReadAsStringAsync();
            if (response.IsSuccessStatusCode)
            {
                var ret = System.Text.Json.JsonSerializer.Deserialize<Retorno>(body);
                if (ret?.sucesso == true)
                {
                    _mensagemSucesso = "Conta excluída com sucesso.";
                    await CarregarLista();
                }
                else
                {
                    _mensagemErro = ret?.mensagem ?? body;
                }
            }
            else
            {
                _mensagemErro = string.IsNullOrWhiteSpace(body) ? response.ReasonPhrase : body;
            }
        }
        catch (Exception ex)
        {
            _mensagemErro = ex.Message;
        }
        StateHasChanged();
    }

    private void OnTipoContaChanged(ChangeEventArgs e)
    {
        if (_editando != null && e.Value != null && int.TryParse(e.Value.ToString(), out int novoValor))
        {
            _editando.tipoconta = novoValor;
            StateHasChanged();
        }
    }

    private void MudarAba(int index)
    {
        _activeTabIndex = index;
        StateHasChanged();
    }

    private string GetTabClass(int index)
    {
        return _activeTabIndex == index 
            ? "border-blue-500 text-blue-600" 
            : "border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700";
    }

    private async Task TestarEnvioEmail()
    {
        if (string.IsNullOrWhiteSpace(_testeEmailDestinatario))
        {
            _mensagemTesteEnvio = "Informe o e-mail destinatário";
            _testeEnvioSucesso = false;
            StateHasChanged();
            return;
        }

        _testandoEnvio = true;
        _mensagemTesteEnvio = string.Empty;
        _testeEnvioSucesso = false;
        StateHasChanged();

        try
        {
            // Simula o envio de email - aqui você pode implementar a lógica real
            await Task.Delay(1500);
            
            _mensagemTesteEnvio = "E-mail de teste enviado com sucesso! (Funcionalidade simulada)";
            _testeEnvioSucesso = true;
        }
        catch (Exception ex)
        {
            _mensagemTesteEnvio = $"Erro ao testar envio: {ex.Message}";
            _testeEnvioSucesso = false;
        }
        finally
        {
            _testandoEnvio = false;
            StateHasChanged();
        }
    }

    private async Task TestarRecebimentoEmail()
    {
        _testandoRecebimento = true;
        _mensagemTesteRecebimento = string.Empty;
        _testeRecebimentoSucesso = false;
        StateHasChanged();

        try
        {
            // Simula o teste de recebimento - aqui você pode implementar a lógica real
            await Task.Delay(1500);

            if (_editando?.receberemail == false)
            {
                _mensagemTesteRecebimento = "Recebimento de e-mail está desabilitado para esta conta.";
                _testeRecebimentoSucesso = false;
            }
            else
            {
                _mensagemTesteRecebimento = "Teste de recebimento executado com sucesso! (Funcionalidade simulada)";
                _testeRecebimentoSucesso = true;
            }
        }
        catch (Exception ex)
        {
            _mensagemTesteRecebimento = $"Erro ao testar recebimento: {ex.Message}";
            _testeRecebimentoSucesso = false;
        }
        finally
        {
            _testandoRecebimento = false;
            StateHasChanged();
        }
    }
}
