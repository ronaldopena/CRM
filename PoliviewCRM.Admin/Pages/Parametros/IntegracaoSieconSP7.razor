@page "/parametros/integracao-sieconsp7"
@inject HttpClient Http

<PageTitle>Integração SIECONSP7 | Parâmetros | SIECON CRM</PageTitle>

<div class="mx-auto max-w-7xl p-4 md:p-6">
    <div class="rounded-t-lg bg-gray-100 dark:bg-gray-800 px-4 py-3 md:px-6">
        <h1 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Parâmetros do Sistema</h1>
    </div>
    <div class="border-x border-b border-gray-200 bg-white dark:bg-[#1a2233] dark:border-gray-700 px-4 py-6 md:px-6">
        <h2 class="mb-4 text-base font-semibold text-gray-800 dark:text-gray-200">Integração SIECONSP7</h2>

        @if (_carregandoIntegracao)
        {
            <p class="text-sm text-gray-500">Carregando...</p>
        }
        else if (_integracao is null && !string.IsNullOrEmpty(_mensagemErro))
        {
            <div class="space-y-3">
                <p class="text-sm font-medium text-red-600">@_mensagemErro</p>
                @if (!string.IsNullOrEmpty(_detalheErroCarregamento))
                {
                    <details class="rounded-lg border border-gray-200 bg-gray-50">
                        <summary class="cursor-pointer px-3 py-2 text-sm font-medium text-gray-700">Detalhes técnicos do erro</summary>
                        <pre class="overflow-x-auto whitespace-pre-wrap break-words px-3 py-2 text-xs text-gray-600">@_detalheErroCarregamento</pre>
                    </details>
                }
            </div>
        }
        else if (_integracao is not null)
        {
            <div class="max-w-2xl space-y-4">
                @if (!string.IsNullOrEmpty(_mensagemSucesso))
                {
                    <div class="rounded-lg bg-green-50 px-4 py-3 text-sm text-green-800">@_mensagemSucesso</div>
                }
                @if (!string.IsNullOrEmpty(_mensagemErro))
                {
                    <div class="space-y-2">
                        <div class="rounded-lg bg-red-50 px-4 py-3 text-sm text-red-700">@_mensagemErro</div>
                        @if (!string.IsNullOrEmpty(_detalheErroSalvar))
                        {
                            <details class="rounded-lg border border-red-200 bg-red-50/50">
                                <summary class="cursor-pointer px-3 py-2 text-sm font-medium text-red-800">Detalhes técnicos</summary>
                                <pre class="overflow-x-auto whitespace-pre-wrap break-words px-3 py-2 text-xs text-red-700">@_detalheErroSalvar</pre>
                            </details>
                        }
                    </div>
                }
                <div class="grid gap-4 sm:grid-cols-1">
                    <div>
                        <label class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300">Servidor</label>
                        <InputText @bind-Value="_integracao.Servidor"
                            class="w-full rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-[#1a2233] dark:text-gray-200 dark:placeholder-gray-500 px-3 py-2 text-sm" placeholder="Servidor" />
                    </div>
                    <div>
                        <label class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300">Usuário</label>
                        <InputText @bind-Value="_integracao.Usuario"
                            class="w-full rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-[#1a2233] dark:text-gray-200 dark:placeholder-gray-500 px-3 py-2 text-sm" placeholder="Usuário" />
                    </div>
                    <div>
                        <label class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300">Senha</label>
                        <InputText @bind-Value="_integracao.Senha" type="password"
                            class="w-full rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-[#1a2233] dark:text-gray-200 dark:placeholder-gray-500 px-3 py-2 text-sm" placeholder="Senha" />
                    </div>
                    <div>
                        <label class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300">Caminho Servidor</label>
                        <InputText @bind-Value="_integracao.CaminhoServidor"
                            class="w-full rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-[#1a2233] dark:text-gray-200 dark:placeholder-gray-500 px-3 py-2 text-sm"
                            placeholder="Caminho do servidor (path DB)" />
                    </div>
                    <div>
                        <label class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300">Porta Servidor</label>
                        <InputText @bind-Value="_integracao.PortaServidor"
                            class="w-full rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-[#1a2233] dark:text-gray-200 dark:placeholder-gray-500 px-3 py-2 text-sm" placeholder="Porta" />
                    </div>
                    <div>
                        <button type="button" @onclick="SalvarIntegracaoSieconSP7"
                            class="rounded-lg bg-primary-500 px-4 py-2 text-sm font-medium text-white hover:bg-primary-600 disabled:opacity-50 disabled:cursor-not-allowed">
                            @(_salvandoIntegracao ? "Salvando..." : "Salvar")
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private IntegracaoSieconSP7ViewModel? _integracao;
    private bool _carregandoIntegracao;
    private bool _salvandoIntegracao;
    private string? _mensagemSucesso;
    private string? _mensagemErro;
    private string? _detalheErroCarregamento;
    private string? _detalheErroSalvar;

    protected override async Task OnInitializedAsync()
    {
        await CarregarParametros();
    }

    private async Task CarregarParametros()
    {
        _carregandoIntegracao = true;
        _mensagemErro = null;
        _detalheErroCarregamento = null;
        try
        {
            var response = await Http.GetAsync("parametros");
            if (response.IsSuccessStatusCode)
            {
                _integracao = await response.Content.ReadFromJsonAsync<IntegracaoSieconSP7ViewModel>();
            }
            else
            {
                var bodyErro = await response.Content.ReadAsStringAsync();
                _mensagemErro = $"Erro ao carregar parâmetros. Status: {(int)response.StatusCode} ({response.StatusCode})";
                _detalheErroCarregamento = string.IsNullOrWhiteSpace(bodyErro)
                    ? $"HTTP {(int)response.StatusCode} - {response.ReasonPhrase}"
                    : $"HTTP {(int)response.StatusCode}\nResposta: {bodyErro}";
            }
        }
        catch (HttpRequestException ex)
        {
            _mensagemErro = "Não foi possível conectar à API.";
            _detalheErroCarregamento = $"{ex.GetType().Name}: {ex.Message}\nInner: {ex.InnerException?.Message}";
        }
        catch (TaskCanceledException ex)
        {
            _mensagemErro = "Requisição cancelada ou tempo esgotado.";
            _detalheErroCarregamento = ex.Message;
        }
        catch (Exception ex)
        {
            _mensagemErro = "Não foi possível carregar os parâmetros.";
            _detalheErroCarregamento = $"{ex.GetType().Name}: {ex.Message}\nInner: {ex.InnerException?.Message}\nStack: {ex.StackTrace}";
        }
        finally
        {
            _carregandoIntegracao = false;
        }
    }

    private async Task SalvarIntegracaoSieconSP7()
    {
        if (_integracao is null) return;
        _mensagemErro = null;
        _mensagemSucesso = null;
        _detalheErroSalvar = null;
        _salvandoIntegracao = true;
        StateHasChanged();
        try
        {
            var body = new ParametrosIntegracaoSieconSP7Requisicao
            {
                NM_ServidorInteg = _integracao.Servidor,
                NM_UsuarioInteg = _integracao.Usuario,
                DS_SenhaUserInteg = _integracao.Senha,
                DS_PathDbInteg = _integracao.CaminhoServidor,
                DS_portaServidorInteg = _integracao.PortaServidor
            };
            var response = await Http.PutAsJsonAsync("parametros/integracao-sieconsp7", body);
            if (response.IsSuccessStatusCode)
            {
                _mensagemSucesso = "Parâmetros salvos com sucesso.";
            }
            else
            {
                var bodyErro = await response.Content.ReadAsStringAsync();
                _mensagemErro = response.StatusCode == System.Net.HttpStatusCode.Unauthorized
                    ? "Não autorizado. Faça login novamente."
                    : (string.IsNullOrWhiteSpace(bodyErro) ? $"Erro {response.StatusCode}" : bodyErro);
                _detalheErroSalvar = $"HTTP {(int)response.StatusCode} ({response.StatusCode})\nResposta: {bodyErro}";
            }
        }
        catch (HttpRequestException ex)
        {
            _mensagemErro = "Não foi possível conectar à API.";
            _detalheErroSalvar = $"{ex.GetType().Name}: {ex.Message}\nInner: {ex.InnerException?.Message}";
        }
        catch (Exception ex)
        {
            _mensagemErro = ex.Message;
            _detalheErroSalvar = $"{ex.GetType().Name}: {ex.Message}\nInner: {ex.InnerException?.Message}\nStack: {ex.StackTrace}";
        }
        finally
        {
            _salvandoIntegracao = false;
            StateHasChanged();
        }
    }
}
