@page "/parametros/sla"
@inject HttpClient Http

<PageTitle>Configuração de SLA | Parâmetros | SIECON CRM</PageTitle>

<div class="mx-auto max-w-7xl p-4 md:p-6">
    <div class="rounded-t-lg bg-gray-100 px-4 py-3 md:px-6">
        <h1 class="text-lg font-semibold text-gray-800">Parâmetros do Sistema</h1>
    </div>
    <div class="border-x border-b border-gray-200 bg-white px-4 py-6 md:px-6">
        <h2 class="mb-4 text-base font-semibold text-gray-800">Configuração de Percentuais de Monitoramento de SLA</h2>

        @if (_carregando)
        {
            <p class="text-sm text-gray-500">Carregando...</p>
        }
        else if (_sla is null && !string.IsNullOrEmpty(_mensagemErro))
        {
            <div class="space-y-3">
                <p class="text-sm font-medium text-red-600">@_mensagemErro</p>
                @if (!string.IsNullOrEmpty(_detalheErroCarregamento))
                {
                    <details class="rounded-lg border border-gray-200 bg-gray-50">
                        <summary class="cursor-pointer px-3 py-2 text-sm font-medium text-gray-700">Detalhes técnicos do erro</summary>
                        <pre class="overflow-x-auto whitespace-pre-wrap break-words px-3 py-2 text-xs text-gray-600">@_detalheErroCarregamento</pre>
                    </details>
                }
            </div>
        }
        else if (_sla is not null)
        {
            <div class="max-w-2xl space-y-4">
                @if (!string.IsNullOrEmpty(_mensagemSucesso))
                {
                    <div class="rounded-lg bg-green-50 px-4 py-3 text-sm text-green-800">@_mensagemSucesso</div>
                }
                @if (!string.IsNullOrEmpty(_mensagemErro))
                {
                    <div class="space-y-2">
                        <div class="rounded-lg bg-red-50 px-4 py-3 text-sm text-red-700">@_mensagemErro</div>
                        @if (!string.IsNullOrEmpty(_detalheErroSalvar))
                        {
                            <details class="rounded-lg border border-red-200 bg-red-50/50">
                                <summary class="cursor-pointer px-3 py-2 text-sm font-medium text-red-800">Detalhes técnicos</summary>
                                <pre class="overflow-x-auto whitespace-pre-wrap break-words px-3 py-2 text-xs text-red-700">@_detalheErroSalvar</pre>
                            </details>
                        }
                    </div>
                }
                <div class="space-y-6">
                    <div class="grid gap-4 sm:grid-cols-2">
                        <div>
                            <label class="mb-1 flex items-center gap-2 text-sm font-medium text-gray-700">
                                <span class="flex h-4 w-4 items-center justify-center rounded-full bg-yellow-500"></span>
                                Estado de Alerta (%)
                            </label>
                            <InputNumber @bind-Value="_sla.NR_SLAAlerta" 
                                class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" 
                                min="0" max="100" />
                            <p class="mt-1 text-xs text-gray-500">Percentual em que o SLA entra em estado de alerta</p>
                        </div>
                        <div>
                            <label class="mb-1 flex items-center gap-2 text-sm font-medium text-gray-700">
                                <span class="flex h-4 w-4 items-center justify-center rounded-full bg-red-500"></span>
                                Estado Crítico (%)
                            </label>
                            <InputNumber @bind-Value="_sla.NR_SLACritico" 
                                class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" 
                                min="0" max="100" />
                            <p class="mt-1 text-xs text-gray-500">Percentual em que o SLA entra em estado crítico</p>
                        </div>
                    </div>

                    <div class="rounded-lg border border-gray-200 p-4">
                        <div class="flex items-center gap-2">
                            <InputCheckbox @bind-Value="_sla.horasUteisCalcSLA" id="horasUteisCalcSLA" class="h-4 w-4 rounded border-gray-300" />
                            <label for="horasUteisCalcSLA" class="text-sm font-medium text-gray-700">
                                Considerar horas úteis (JORNADA) no cálculo do SLA?
                            </label>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Quando marcado, o cálculo do SLA considera apenas as horas úteis definidas na jornada</p>
                    </div>

                    <div>
                        <button type="button" @onclick="SalvarSLA"
                            class="rounded-lg bg-primary-500 px-4 py-2 text-sm font-medium text-white hover:bg-primary-600 disabled:opacity-50 disabled:cursor-not-allowed">
                            @(_salvando ? "Salvando..." : "Salvar")
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private SLAParametrosViewModel? _sla;
    private bool _carregando;
    private bool _salvando;
    private string? _mensagemSucesso;
    private string? _mensagemErro;
    private string? _detalheErroCarregamento;
    private string? _detalheErroSalvar;

    protected override async Task OnInitializedAsync()
    {
        await CarregarParametros();
    }

    private async Task CarregarParametros()
    {
        _carregando = true;
        _mensagemErro = null;
        _detalheErroCarregamento = null;
        try
        {
            var response = await Http.GetAsync("parametros");
            if (response.IsSuccessStatusCode)
            {
                var parametros = await response.Content.ReadFromJsonAsync<Parametros>();
                if (parametros != null)
                {
                    _sla = new SLAParametrosViewModel
                    {
                        NR_SLAAlerta = parametros.NR_SLAAlerta,
                        NR_SLACritico = parametros.NR_SLACritico,
                        horasUteisCalcSLA = parametros.horasUteisCalcSLA
                    };
                }
            }
            else
            {
                var bodyErro = await response.Content.ReadAsStringAsync();
                _mensagemErro = $"Erro ao carregar parâmetros. Status: {(int)response.StatusCode} ({response.StatusCode})";
                _detalheErroCarregamento = string.IsNullOrWhiteSpace(bodyErro)
                    ? $"HTTP {(int)response.StatusCode} - {response.ReasonPhrase}"
                    : $"HTTP {(int)response.StatusCode}\nResposta: {bodyErro}";
            }
        }
        catch (HttpRequestException ex)
        {
            _mensagemErro = "Não foi possível conectar à API.";
            _detalheErroCarregamento = $"{ex.GetType().Name}: {ex.Message}\nInner: {ex.InnerException?.Message}";
        }
        catch (TaskCanceledException ex)
        {
            _mensagemErro = "Requisição cancelada ou tempo esgotado.";
            _detalheErroCarregamento = ex.Message;
        }
        catch (Exception ex)
        {
            _mensagemErro = "Não foi possível carregar os parâmetros.";
            _detalheErroCarregamento = $"{ex.GetType().Name}: {ex.Message}\nInner: {ex.InnerException?.Message}\nStack: {ex.StackTrace}";
        }
        finally
        {
            _carregando = false;
        }
    }

    private async Task SalvarSLA()
    {
        if (_sla is null) return;
        _salvando = true;
        _mensagemErro = null;
        _mensagemSucesso = null;
        _detalheErroSalvar = null;
        StateHasChanged();
        try
        {
            var body = new ParametrosSLARequisicao
            {
                NR_SLAAlerta = _sla.NR_SLAAlerta,
                NR_SLACritico = _sla.NR_SLACritico,
                horasUteisCalcSLA = _sla.horasUteisCalcSLA
            };
            var response = await Http.PutAsJsonAsync("parametros/sla", body);
            if (response.IsSuccessStatusCode)
            {
                _mensagemSucesso = "Parâmetros de SLA salvos com sucesso.";
            }
            else
            {
                var bodyErro = await response.Content.ReadAsStringAsync();
                _mensagemErro = response.StatusCode == System.Net.HttpStatusCode.Unauthorized
                    ? "Não autorizado. Faça login novamente."
                    : (string.IsNullOrWhiteSpace(bodyErro) ? $"Erro {response.StatusCode}" : bodyErro);
                _detalheErroSalvar = $"HTTP {(int)response.StatusCode} ({response.StatusCode})\nResposta: {bodyErro}";
            }
        }
        catch (HttpRequestException ex)
        {
            _mensagemErro = "Não foi possível conectar à API.";
            _detalheErroSalvar = $"{ex.GetType().Name}: {ex.Message}\nInner: {ex.InnerException?.Message}";
        }
        catch (Exception ex)
        {
            _mensagemErro = ex.Message;
            _detalheErroSalvar = $"{ex.GetType().Name}: {ex.Message}\nInner: {ex.InnerException?.Message}\nStack: {ex.StackTrace}";
        }
        finally
        {
            _salvando = false;
            StateHasChanged();
        }
    }
}
