@page "/parametros/caminhos"
@inject HttpClient Http

<PageTitle>Caminhos | Parâmetros | SIECON CRM</PageTitle>

<div class="mx-auto max-w-7xl p-4 md:p-6">
    <div class="rounded-t-lg bg-gray-100 dark:bg-gray-800 px-4 py-3 md:px-6">
        <h1 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Parâmetros do Sistema</h1>
    </div>
    <div class="border-x border-b border-gray-200 bg-white dark:bg-[#1a2233] dark:border-gray-700 px-4 py-6 md:px-6">
        <h2 class="mb-4 text-base font-semibold text-gray-800 dark:text-gray-200">Caminhos</h2>

        @if (_carregando)
        {
            <p class="text-sm text-gray-500 dark:text-gray-400">Carregando...</p>
        }
        else if (_caminhos is null && !string.IsNullOrEmpty(_mensagemErro))
        {
            <div class="space-y-3">
                <p class="text-sm font-medium text-red-600 dark:text-red-400">@_mensagemErro</p>
                @if (!string.IsNullOrEmpty(_detalheErroCarregamento))
                {
                    <details class="rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800">
                        <summary class="cursor-pointer px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300">Detalhes técnicos do erro</summary>
                        <pre class="overflow-x-auto whitespace-pre-wrap break-words px-3 py-2 text-xs text-gray-600 dark:text-gray-400">@_detalheErroCarregamento</pre>
                    </details>
                }
            </div>
        }
        else if (_caminhos is not null)
        {
            <div class="max-w-2xl space-y-4">
                @if (!string.IsNullOrEmpty(_mensagemSucesso))
                {
                    <div class="rounded-lg bg-green-50 dark:bg-green-900/20 px-4 py-3 text-sm text-green-800 dark:text-green-300">@_mensagemSucesso</div>
                }
                @if (!string.IsNullOrEmpty(_mensagemErro))
                {
                    <div class="space-y-2">
                        <div class="rounded-lg bg-red-50 dark:bg-red-900/20 px-4 py-3 text-sm text-red-700 dark:text-red-300">@_mensagemErro</div>
                        @if (!string.IsNullOrEmpty(_detalheErroSalvar))
                        {
                            <details class="rounded-lg border border-red-200 dark:border-red-800 bg-red-50/50 dark:bg-red-900/10">
                                <summary class="cursor-pointer px-3 py-2 text-sm font-medium text-red-800 dark:text-red-300">Detalhes técnicos</summary>
                                <pre class="overflow-x-auto whitespace-pre-wrap break-words px-3 py-2 text-xs text-red-700 dark:text-red-400">@_detalheErroSalvar</pre>
                            </details>
                        }
                    </div>
                }
                <div class="space-y-6">
                    <div>
                        <label for="pastaInstalacaoCrm" class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300">Pasta Instalação CRM</label>
                        <input type="text" id="pastaInstalacaoCrm" @bind="_caminhos.PastaInstalacaoCRM"
                            class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500" />
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Caminho completo da pasta de instalação do CRM (OPE_PARAMETRO.PastaInstalacaoCRM)</p>
                    </div>
                    <div>
                        <label for="pathInstallSiecon" class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300">Pasta Instalação SIECON</label>
                        <input type="text" id="pathInstallSiecon" @bind="_caminhos.DS_PathInstallSistemaSiecon"
                            class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500" />
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Caminho completo da pasta de instalação do SIECON (OPE_PARAMETRO.DS_PathInstallSistemaSiecon)</p>
                    </div>
                    <div>
                        <button type="button" @onclick="SalvarCaminhos"
                            class="rounded-lg bg-primary-500 px-4 py-2 text-sm font-medium text-white hover:bg-primary-600 disabled:opacity-50 disabled:cursor-not-allowed">
                            @(_salvando ? "Salvando..." : "Salvar")
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private CaminhosViewModel? _caminhos;
    private bool _carregando = true;
    private bool _salvando;
    private string? _mensagemSucesso;
    private string? _mensagemErro;
    private string? _detalheErroCarregamento;
    private string? _detalheErroSalvar;

    private class CaminhosViewModel
    {
        public string? PastaInstalacaoCRM { get; set; }
        public string? DS_PathInstallSistemaSiecon { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await CarregarParametros();
    }

    private async Task CarregarParametros()
    {
        _carregando = true;
        _mensagemErro = null;
        _detalheErroCarregamento = null;
        try
        {
            var response = await Http.GetAsync("parametros");
            if (response.IsSuccessStatusCode)
            {
                var parametros = await response.Content.ReadFromJsonAsync<Parametros>();
                if (parametros != null)
                {
                    _caminhos = new CaminhosViewModel
                    {
                        PastaInstalacaoCRM = parametros.PastaInstalacaoCRM ?? "",
                        DS_PathInstallSistemaSiecon = parametros.caminhoSiecon ?? ""
                    };
                }
            }
            else
            {
                var bodyErro = await response.Content.ReadAsStringAsync();
                _mensagemErro = $"Erro ao carregar parâmetros. Status: {(int)response.StatusCode} ({response.StatusCode})";
                _detalheErroCarregamento = string.IsNullOrWhiteSpace(bodyErro)
                    ? $"HTTP {(int)response.StatusCode} - {response.ReasonPhrase}"
                    : $"HTTP {(int)response.StatusCode}\nResposta: {bodyErro}";
            }
        }
        catch (HttpRequestException ex)
        {
            _mensagemErro = "Não foi possível conectar à API.";
            _detalheErroCarregamento = $"{ex.GetType().Name}: {ex.Message}\nInner: {ex.InnerException?.Message}";
        }
        catch (TaskCanceledException ex)
        {
            _mensagemErro = "Requisição cancelada ou tempo esgotado.";
            _detalheErroCarregamento = ex.Message;
        }
        catch (Exception ex)
        {
            _mensagemErro = "Não foi possível carregar os parâmetros.";
            _detalheErroCarregamento = $"{ex.GetType().Name}: {ex.Message}\nInner: {ex.InnerException?.Message}\nStack: {ex.StackTrace}";
        }
        finally
        {
            _carregando = false;
        }
    }

    private async Task SalvarCaminhos()
    {
        if (_caminhos is null) return;
        _salvando = true;
        _mensagemErro = null;
        _mensagemSucesso = null;
        _detalheErroSalvar = null;
        StateHasChanged();
        try
        {
            var body = new ParametrosCaminhosRequisicao
            {
                PastaInstalacaoCRM = _caminhos.PastaInstalacaoCRM,
                DS_PathInstallSistemaSiecon = _caminhos.DS_PathInstallSistemaSiecon
            };
            var response = await Http.PutAsJsonAsync("parametros/caminhos", body);
            if (response.IsSuccessStatusCode)
            {
                _mensagemSucesso = "Caminhos salvos com sucesso.";
            }
            else
            {
                var bodyErro = await response.Content.ReadAsStringAsync();
                _mensagemErro = response.StatusCode == System.Net.HttpStatusCode.Unauthorized
                    ? "Não autorizado. Faça login novamente."
                    : (string.IsNullOrWhiteSpace(bodyErro) ? $"Erro {response.StatusCode}" : bodyErro);
                _detalheErroSalvar = $"HTTP {(int)response.StatusCode} ({response.StatusCode})\nResposta: {bodyErro}";
            }
        }
        catch (HttpRequestException ex)
        {
            _mensagemErro = "Não foi possível conectar à API.";
            _detalheErroSalvar = $"{ex.GetType().Name}: {ex.Message}\nInner: {ex.InnerException?.Message}";
        }
        catch (Exception ex)
        {
            _mensagemErro = ex.Message;
            _detalheErroSalvar = $"{ex.GetType().Name}: {ex.Message}\nInner: {ex.InnerException?.Message}\nStack: {ex.StackTrace}";
        }
        finally
        {
            _salvando = false;
            StateHasChanged();
        }
    }
}
